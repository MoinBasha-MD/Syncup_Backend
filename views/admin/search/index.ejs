<!-- Page Header -->
<div style="margin-bottom: 24px;">
    <h3 style="font-size: 20px; font-weight: 700; color: #0f172a; margin: 0 0 4px 0;">Advanced Search</h3>
    <p style="color: #64748b; margin: 0;">Search across all resources</p>
</div>

<!-- Search Box -->
<div class="table-card" style="margin-bottom: 24px;">
    <form id="searchForm">
        <div class="row g-3">
            <div class="col-md-8">
                <input type="text" id="searchQuery" class="form-control" placeholder="Search users, groups, posts, messages..." value="<%= query %>" style="border-radius: 10px; border: 1px solid #E2E8F0; padding: 12px 16px; font-size: 16px;">
            </div>
            <div class="col-md-4">
                <select id="searchType" class="form-select" style="border-radius: 10px; border: 1px solid #E2E8F0; padding: 12px 16px;">
                    <option value="all">All Resources</option>
                    <option value="users">Users Only</option>
                    <option value="groups">Groups Only</option>
                    <option value="posts">Posts Only</option>
                    <option value="messages">Messages Only</option>
                </select>
            </div>
        </div>
    </form>
</div>

<!-- Results -->
<div id="results">
    <% if (query) { %>
        <p style="text-align: center; padding: 40px; color: #64748b;">
            <i class="fas fa-spinner fa-spin fa-2x mb-3"></i><br>
            Searching...
        </p>
    <% } else { %>
        <div style="text-align: center; padding: 60px;">
            <i class="fas fa-search fa-3x mb-3" style="color: #cbd5e1;"></i>
            <p style="color: #64748b; font-size: 18px;">Enter a search query to get started</p>
        </div>
    <% } %>
</div>

<script>
let searchTimeout;

document.getElementById('searchQuery').addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => performSearch(), 500);
});

document.getElementById('searchType').addEventListener('change', performSearch);

async function performSearch() {
    const query = document.getElementById('searchQuery').value;
    const type = document.getElementById('searchType').value;
    
    if (!query) {
        document.getElementById('results').innerHTML = `
            <div style="text-align: center; padding: 60px;">
                <i class="fas fa-search fa-3x mb-3" style="color: #cbd5e1;"></i>
                <p style="color: #64748b; font-size: 18px;">Enter a search query to get started</p>
            </div>
        `;
        return;
    }
    
    document.getElementById('results').innerHTML = '<p style="text-align: center; padding: 40px; color: #64748b;"><i class="fas fa-spinner fa-spin fa-2x mb-3"></i><br>Searching...</p>';
    
    try {
        const res = await fetch(`/admin/api/search?q=${encodeURIComponent(query)}&type=${type}`);
        const data = await res.json();
        
        if (!data.success) {
            document.getElementById('results').innerHTML = '<p style="text-align: center; padding: 40px; color: #ef4444;">Error searching</p>';
            return;
        }
        
        let html = '';
        
        // Users
        if (data.results.users && data.results.users.length > 0) {
            html += `
                <div class="table-card" style="margin-bottom: 24px;">
                    <h5 style="margin-bottom: 16px;"><i class="fas fa-users me-2"></i>Users (${data.results.users.length})</h5>
                    <div class="table-responsive">
                        <table class="table">
                            <tbody>
                                ${data.results.users.map(u => `
                                    <tr>
                                        <td><a href="/admin/users/${u._id}">${u.name}</a></td>
                                        <td>${u.email || 'N/A'}</td>
                                        <td>${u.phoneNumber}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        // Groups
        if (data.results.groups && data.results.groups.length > 0) {
            html += `
                <div class="table-card" style="margin-bottom: 24px;">
                    <h5 style="margin-bottom: 16px;"><i class="fas fa-layer-group me-2"></i>Groups (${data.results.groups.length})</h5>
                    <div class="table-responsive">
                        <table class="table">
                            <tbody>
                                ${data.results.groups.map(g => `
                                    <tr>
                                        <td><a href="/admin/groups/${g._id}">${g.name}</a></td>
                                        <td>${g.description || 'N/A'}</td>
                                        <td>${g.membersCount} members</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        // Posts
        if (data.results.posts && data.results.posts.length > 0) {
            html += `
                <div class="table-card" style="margin-bottom: 24px;">
                    <h5 style="margin-bottom: 16px;"><i class="fas fa-file-alt me-2"></i>Posts (${data.results.posts.length})</h5>
                    <div class="table-responsive">
                        <table class="table">
                            <tbody>
                                ${data.results.posts.map(p => `
                                    <tr>
                                        <td>${p.content.substring(0, 100)}...</td>
                                        <td>${new Date(p.createdAt).toLocaleDateString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        if (!html) {
            html = '<p style="text-align: center; padding: 40px; color: #64748b;">No results found</p>';
        }
        
        document.getElementById('results').innerHTML = html;
        
    } catch (error) {
        document.getElementById('results').innerHTML = '<p style="text-align: center; padding: 40px; color: #ef4444;">Error searching</p>';
    }
}

</script>

<% if (query) { %>
<script>
    performSearch();
</script>
<% } %>
